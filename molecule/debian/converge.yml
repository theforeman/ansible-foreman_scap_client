---
- name: Converge
  hosts: all
  pre_tasks:
    - name: 'Install dependencies'
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
        update_cache: true
      with_items:
        - systemd-cron
        - python3-debian
        - gnupg

    - name: Configure gpg_key for client repository (apt)
      ansible.builtin.get_url:
        url: "https://oss.atix.de/atix_gpg.pub"
        dest: "/etc/apt/trusted.gpg.d/foreman_client.asc"
        mode: '0644'

    - name: Configure client repository (apt)
      ansible.builtin.deb822_repository:
        name: "foreman_client"
        types: "deb"
        uris: "https://oss.atix.de/Debian13/"
        suites: "stable"
        components: "main"
        state: "present"
        signed_by: "/etc/apt/trusted.gpg.d/foreman_client.asc"

    - name: Run apt-get update
      ansible.builtin.apt:
        update_cache: true

    - name: 'Install subscription-manager'
      ansible.builtin.package:
        name: subscription-manager
        state: present
  roles:
    - role: theforeman.foreman_scap_client
  vars:
    foreman_scap_client_repo_state: present
    foreman_scap_client_server: https://foreman.example.com
    foreman_scap_client_port: 9090
    foreman_scap_client_cron_splay_seed: 42
    foreman_scap_client_http_proxy_server: 'https://proxy.example.com'
    foreman_scap_client_http_proxy_port: 7475
    foreman_scap_client_fetch_remote_resources: true
    foreman_scap_client_timeout: 61
    foreman_scap_client_policies: [
      {
        "id": "1",
        "hour": "12",
        "minute": "1",
        "month": "*",
        "monthday": "*",
        "weekday": "1",
        "profile_id": "",
        "content_path": "/usr/share/xml/scap/ssg/fedora/ssg-fedora-ds.xml",
        "download_path": "/compliance/policies/1/content",
        "tailoring_path": "/var/lib/openscap/ssg-fedora-ds-tailored.xml",
        "tailoring_download_path": "/compliance/policies/1/tailoring"
      }
    ]
